### Отток клиентов телеком

### Цель проекта

На основании статистики построить модели машинного обучения которая сможет предсказывать какие клиенты планируют уйти, чтобы иметь возможность удержать их доп условиями


### План работы

целевым показателем является наличие даты (отсутсвие 'NO') в столбце EndDate. Наверное можно все ячейки с датами этого столбца заменить на '1'; 'no' на '0' и решать задачу классификации

* обьединить таблицы в один датафрейм по айди пользователя
* заполнить пропуски в полученной таблице (как минимум часть пропусков указывает на то что услуга не оказывается)
* преименовать столбцы в корректный стиль, заменить целевой признак на 1 и 0 
* выделить из столбца с датами столбец "стажа" пользователя (количество дней с момента подключения)
* удалить признаки которые могут привести к утечке данных
* заменить бинарные ответы в столбцах на 0 и 1
* поделить данные на трейн и тест
* скалировать числовые признаки 
* для столбцов с мультиответами использовать OHE (если нужно для модели) 
* обучить нескольно моделей используя кросвалидацию (ориентировочно думаю про лес, сгд, кэтбуст и линейную). Метрика качества AUC-ROC, бейслайн 0.85
* для перспективных моделей подобрать гиперпараметры
* проверить лучшую модель с настроенными гиперпараметрами на тестовой выборке
* сравнить с константной дамми моделью на тесте
* сделать анализ лучшей модели (матрица ошибок, важность признаков)
* написать вывод

## Выводы

#### выполнено

* обьединить таблицы в один датафрейм по айди пользователя
* заполнить пропуски в полученной таблице
* преименовать столбцы в корректный стиль, заменить целевой признак на 1 и 0 
* выделить из столбца с датами столбец "стажа" пользователя (количество дней с момента подключения)
* удалить признаки которые могут привести к утечке данных
* заменить бинарные ответы в столбцах на 0 и 1
* поделить данные на трейн и тест
* скалировать числовые признаки 
* для столбцов с мультиответами использовать OHE
* обучить нескольно моделей используя кросвалидацию. Метрика качества AUC-ROC, бейслайн 0.85
* для перспективных моделей подобрать гиперпараметры
* проверить лучшую модель с настроенными гиперпараметрами на тестовой выборке
* сделать анализ лучшей модели (матрица ошибок, важность признаков)

#### не выполено
* сравнить с константной дамми моделью на тесте: 
с учетом интересующей нас метрики качества auc-roc значение дамми модели будет 0.5, что по определению ниже бейслайна 0.85, подобная проверка смысла не добавляет



### трудности и подводные камни; решения

при обьединении таблиц образовались пропуски так как количество строк в таблицах df_internet df_phone было меньше. Изначально все отсутсвующие значения таблицы df_internet я заполнил нулями - так как отстуствие упоминания об услуге = отсутсвие услуги; не заметив что столбец internet_service который находится в той же неполной таблице обозначает тип подключения. Подобное заполнение в итоге привело к ошибке при использовании OneHotEnc - так как в столбце были и строковые и цифровые данные. Изменил заполнение пропусков конкретно этого категориального столбца на значения 'unknown'

столбец total_charges был заполнен в строковом формате и при приведении к числовому выдавал ошибку. Как выяснилось это было изза наличия неявных пропусков - новых клиентов зарегистрированных в день создания таблицы. При проверке выяснилось что данные этого столбца введены постфактум оплаты - эти пропуски заполнил нулями и привел ктолбец к типу флоат

пропуски столбцы multiple_lines нет возможности заполнить реальными данными; проверил как отреагирует метрика при разном из заполнении (чтобы не удалять и не терять другие важные данные из этих строк) и заполнил нулями

столбец end_date выполнял 2 функции одновременно: показывал дату отключения и проверял наличие факта отключения; в результате чего имел неудобный тип данных для работы; на основе его копии выделил и заполнил целевой признак; а сам столбец - для актуальных клиентов - заполнил датой конца таблицы - чтобы на основении этого выделить новый признак - "стаж" клиента

обработку категориальных признаков для линейной модели проводил с помощью pd.get_dummies - после фидбека что это не самая удачная практика подготовки данных для МЛ моделей изменил на OHE

изначально в планах было для градиентных моделей подобобрать первичные границы поиска randomSearch-em, а затем "добить" до наилучших показателей gridSearch-em - в примерно нащупанном "наилучшем" диапазоне - однако как оказалось рандом серч работает настолько быстрее что сделать для него более мелкую сетку поиска и попробовать несколько вариантов шага куда быстрее и эффективнее

## Ключевые шаги в решении задачи

### шаги:
* загрузил данные
* рассмотрел каждый из 4 датафреймов 
* проверил корректность дат
* оценил баланс классов целевого признака
* обьединил 4 таблицы в одну по юзер айди
* заполнил появившиеся после обьединения пропуски
* сделал customer_id индексом
* привел столбцы к snake_case
* на основании end_date сформировал столбец целевого признака; привели его к формату 1 \ 0
* для текущих пользователей заполнил end_date датой конца таблицы; перевели в формат даты; сформировал столбец "стажа" пользователя = дельты между началом и концом обслуживания
* удалил end_date и begin_date
* столбцы с бинарной классификацией привел к виду 0 \ 1
* разделил данные на 2 стратифицированные по целевому признаку выборки с соотношением 75 \ 25
* скалировал числовые признаки
* закодировал категориальные признаки с помощью OHE (не пригодилось для итоговой модели)
* обучил нескольно моделей используя кросвалидацию с минимальным тюном чтобы оценить перспективность донастройки (дерево, лес, динейная, кэтбуст, сгд). Метрика качества AUC-ROC, бейслайн 0.85
* затюнил кэт и сгд
* проверили найденные наилучшие настройки модели catboost на тестовой выборке
* для лучшей модели (CatBoostClassifier с параметрами: loss_function="Logloss", eval_metric ='AUC',verbose=50, depth=2, iterations=365, learning_rate=0.36 при random_state = 130323 ) визуализировал важноность признаков; ROC кривую; матрицу ошибок

### ключевые шаги
с учетом важности признаков ключевым шагом можно считать выделение вспомогательного признака - стажа пользователя а так же предобработку данных. После нее все из рассматриваемых моделей показали приемлимый результат, и находились около бейслайна даже при минимальной настройке.


## Признаки лучшей модели.Их предобработка

№ | название признака | предобработка
---|---|---
 1  | type                                                  | без предобработки. Подается в списке categorical в model.fit в параметрах (cat_features=categorical)
 2  |  paperless_billing                      | бинарный признак - переведен из формата Yes \ No в формат 1 \ 0
 3  |  payment_method	                      | без предобработки. Подается в списке categorical в model.fit в параметрах (cat_features=categorical)
 4  |  monthly_charges                             | численный признак. Обучен и скалирован на трейне
 5  |  total_charges	                             | численный признак. был в формате object, и имел неявные пропуски в виде ' '; заменены на нули; переведен в числовой формат.Обучен и скалирован на трейне
 6  |  internet_service                              | категориальный признак, имел пропуски заполненные значением 'unknown'. Подается в списке categorical в model.fit в параметрах (cat_features=categorical)
 7  |  online_security                             | бинарный признак - переведен из формата Yes \ No в формат 1 \ 0. Имел пропуски означающие отстуствие услуги - заполненные нулями
 8  |  online_backup                              | бинарный признак - переведен из формата Yes \ No в формат 1 \ 0. Имел пропуски означающие отстуствие услуги - заполненные нулями
 9  |  device_protection                     | бинарный признак - переведен из формата Yes \ No в формат 1 \ 0. Имел пропуски означающие отстуствие услуги - заполненные нулями
 10 |  tech_support                  | бинарный признак - переведен из формата Yes \ No в формат 1 \ 0. Имел пропуски означающие отстуствие услуги - заполненные нулями
 11 | streaming_tv                    | бинарный признак - переведен из формата Yes \ No в формат 1 \ 0. Имел пропуски означающие отстуствие услуги - заполненные нулями
 12 | streaming_movies                     | бинарный признак - переведен из формата Yes \ No в формат 1 \ 0. Имел пропуски означающие отстуствие услуги - заполненные нулями
 13 | gender             | бинарный признак - переведен из формата Male \ Female в формат 1 \ 0.
 14 | senior_citizen              | без предобработки
 15 | partner             | бинарный признак - переведен из формата Yes \ No в формат 1 \ 0.
 16 | dependents              | бинарный признак - переведен из формата Yes \ No в формат 1 \ 0.
 17 | multiple_lines                     | бинарный признак - переведен из формата Yes \ No в формат 1 \ 0. Имел пропуски которые после проверки заполнены нулями. Приведено в числовой формат
 18 | duration                     | "стаж клиента". требовал несколько этапов; begin_date: приведен в формат даты. end_date: no - заменены на дату конца таблицы, приведен в формат даты. Расчитана дельта между датой end_date и begin_date. Переведена в формат int. Обучена и скалирована на трейне


целевой признак target выделен из копии столбца end_date где начличие даты заменено на 1 и переведено в числовой формат. (1 - соответствует тому что клиент ушел; 0 - не ушел.) Бинарный целевой признак

## итоговая модель

* лучшие показатели у модели CatBoostClassifier с параметрами: loss_function="Logloss", eval_metric ='AUC',verbose=50, depth=2, iterations=365, learning_rate=0.36 при random_state = 130323
* На тестовой выборке интересующая нас метрика auc-roc составила 0.940

 
